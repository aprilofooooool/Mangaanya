# Mangaanya コードリファクタリング 実装タスクリスト

## 概要

Mangaanyaアプリケーションの段階的コード改善を実現するための具体的な実装タスクリスト。5つのPhaseに分けて、既存機能を壊すことなく安全に実施する。

## ⚠️ 重要：タスク実行前の必須確認

**各タスク実行前に必ず以下を実行すること：**
1. `Documents/SAFE_REFACTORING_PLAN.md` の「重要なルール・禁止事項」セクションを読み返す
2. 実行ガイドラインの「各タスク実行前の必須確認事項」を確認する
3. 禁止事項（自動テスト生成禁止、一括置換禁止、短絡的修正禁止）を理解する
4. 慎重な編集と段階的実行の重要性を再認識する

**これらのルールを理解・確認してからタスクを開始すること**

## Phase 1: 基盤整備（低リスク）

### 1. 定数管理システムの構築

- [x] 1.1 定数クラスファイルの作成
  - **ルール確認**: `Documents/SAFE_REFACTORING_PLAN.md` の禁止事項を確認（自動テスト生成禁止、一括置換禁止、短絡的修正禁止）
  - `Constants/ThumbnailConstants.cs` を作成し、サムネイル関連の定数を定義
  - `Constants/BatchSizeConstants.cs` を作成し、バッチ処理関連の定数を定義
  - `Constants/UIConstants.cs` を作成し、UI関連の定数を定義
  - **ビルド確認**: エラーがないことを確認
  - _要件: 1.1_

- [x] 1.2 MainWindow.xaml.cs での定数使用への置き換え
  - **ルール確認**: 文字列一括置換禁止、1行ずつ慎重な編集を再確認
  - マジックナンバーを特定し、定数クラスの値に1つずつ置き換え
  - 各置き換え後にビルドエラーがないことを確認
  - **ビルド確認**: 各変更後に必ずビルド成功を確認
  - _要件: 1.1_

- [x] 1.3 MainViewModel.cs での定数使用への置き換え
  - **ルール確認**: 慎重な編集、変更理由の明確化を再確認
  - マジックナンバーを特定し、定数クラスの値に1つずつ置き換え
  - 各置き換え後にビルドエラーがないことを確認
  - **ビルド確認**: 各変更後に必ずビルド成功を確認
  - _要件: 1.1_

- [x] 1.4 Services層での定数使用への置き換え
  - FileScannerService、ThumbnailService等のマジックナンバーを置き換え
  - 各置き換え後にビルドエラーがないことを確認
  - _要件: 1.1_

### 2. 未使用コードの安全な削除

- [x] 2.1 未使用ファイルの特定と検証
  - プロジェクト内の未使用ファイルを特定
  - 参照関係を詳細に調査し、確実に未使用であることを検証
  - _要件: 1.2_

- [x] 2.2 未使用ファイルの段階的削除
  - 1つずつファイルを削除し、各削除後にビルドエラーがないことを確認
  - アプリケーションの正常起動を確認
  - _要件: 1.2_

### 3. 共通ユーティリティクラスの作成

- [x] 3.1 FileUtilities クラスの作成
  - `Utilities/FileUtilities.cs` を作成
  - FormatFileSize、IsValidMangaFile、GetSafeFileName メソッドを実装
  - _要件: 1.3_

- [x] 3.2 ConversionUtilities クラスの作成
  - `Utilities/ConversionUtilities.cs` を作成
  - FormatRating、ParseDateSafely メソッドを実装
  - _要件: 1.3_

- [x] 3.3 UIHelper クラスの作成
  - `Utilities/UIHelper.cs` を作成
  - 通知表示、確認ダイアログ等の共通UI処理を実装
  - _要件: 1.3_

- [x] 3.4 既存コードでのユーティリティ使用
  - 重複している処理を特定し、ユーティリティメソッド呼び出しに1つずつ置き換え
  - 各置き換え後にビルドエラーがないことを確認
  - _要件: 1.3_

### 4. XMLドキュメントコメントの追加

- [x] 4.1 主要publicメソッドへのコメント追加
  - MainWindow、MainViewModel の主要メソッドにXMLコメントを追加
  - 適切な形式でパラメータ、戻り値、例外を記述
  - _要件: 1.4_

- [x] 4.2 Services層メソッドへのコメント追加
  - FileScannerService、ThumbnailService等の主要メソッドにXMLコメントを追加
  - 各追加後にビルド警告がないことを確認
  - _要件: 1.4_

## Phase 2: 構造改善（中リスク）

### 5. Result パターンの導入

- [x] 5.1 Result<T> クラスの作成
  - `Common/Result.cs` を作成し、成功・失敗状態を表現するクラスを実装
  - Success、Failure の静的メソッドを実装
  - _要件: 2.1_

- [x] 5.2 FileScannerService での Result パターン適用
  - 既存のメソッドをResult<T>型に変更
  - 呼び出し側の処理を Result パターンに対応
  - _要件: 2.1_

- [x] 5.3 ThumbnailService での Result パターン適用
  - 既存のメソッドをResult<T>型に変更
  - エラーハンドリングを統一されたパターンに変更
  - _要件: 2.1_

### 6. 型安全な設定システムの構築

- [x] 6.1 SettingKey<T> クラスの作成
  - `Configuration/SettingKey.cs` を作成し、型安全な設定キーを実装
  - ジェネリック型による型安全性を確保
  - _要件: 2.2_

- [x] 6.2 AppSettings クラスの作成
  - `Configuration/AppSettings.cs` を作成し、全設定キーを定義
  - 既存の文字列キーを型安全なキーに置き換え
  - _要件: 2.2_

- [x] 6.3 設定アクセスの置き換え
  - 既存の文字列ベース設定アクセスを型安全なアクセスに1つずつ置き換え
  - 各置き換え後に設定の読み書きが正常に動作することを確認
  - _要件: 2.2_

### 7. カスタム例外クラスの定義

- [x] 7.1 基底例外クラスの作成
  - `Exceptions/MangaException.cs` を作成し、アプリケーション固有の基底例外を定義
  - 適切な例外階層を構築
  - _要件: 2.4_

- [x] 7.2 ドメイン固有例外クラスの作成
  - FileProcessingException、DatabaseException等の具体的な例外クラスを作成
  - 各例外に適切なプロパティとメッセージを定義
  - _要件: 2.4_

- [x] 7.3 既存例外処理の置き換え
  - 汎用例外をドメイン固有例外に1つずつ置き換え
  - より詳細なエラー情報が提供されることを確認
  - _要件: 2.4_

## Phase 3: アーキテクチャ改善（高リスク）

### 8. MainWindow.xaml.cs の部分クラス分割

- [x] 8.1 MainWindow.DataGrid.cs の作成
  - DataGrid関連の処理を新しい部分クラスファイルに移動
  - 列の表示/非表示制御、ソート処理、選択処理を移動
  - _要件: 3.1_

- [ ] 8.2 MainWindow.Events.cs の作成
  - イベントハンドラーを新しい部分クラスファイルに移動
  - マウス、キーボード、ウィンドウイベントハンドラーを移動
  - _要件: 3.1_

- [ ] 8.3 MainWindow.Settings.cs の作成
  - 設定関連処理を新しい部分クラスファイルに移動
  - ウィンドウ設定、列設定の保存/復元処理を移動
  - _要件: 3.1_

- [ ] 8.4 MainWindow.FileOperations.cs の作成
  - ファイル操作関連処理を新しい部分クラスファイルに移動
  - ファイルのドラッグ&ドロップ、開く、削除処理を移動
  - _要件: 3.1_

- [ ] 8.5 MainWindow.UI.cs の作成
  - UI制御関連処理を新しい部分クラスファイルに移動
  - 表示モード切り替え、レイアウト調整処理を移動
  - _要件: 3.1_

### 9. MainViewModel の責任分離

- [ ] 9.1 FileManagementViewModel の作成
  - ファイル管理関連の処理を新しいViewModelに分離
  - ファイルリスト、選択状態、フィルタリング処理を移動
  - _要件: 3.2_

- [ ] 9.2 SearchViewModel の作成
  - 検索機能関連の処理を新しいViewModelに分離
  - 検索条件、検索実行、結果表示処理を移動
  - _要件: 3.2_

- [ ] 9.3 ThumbnailViewModel の作成
  - サムネイル管理関連の処理を新しいViewModelに分離
  - サムネイル生成、キャッシュ、表示制御を移動
  - _要件: 3.2_

- [ ] 9.4 SettingsViewModel の作成
  - 設定管理関連の処理を新しいViewModelに分離
  - 設定値の管理、変更通知、永続化処理を移動
  - _要件: 3.2_

- [ ] 9.5 StatusViewModel の作成
  - ステータス表示関連の処理を新しいViewModelに分離
  - 進捗表示、メッセージ表示、統計情報を移動
  - _要件: 3.2_

- [ ] 9.6 MainViewModel の統合制御実装
  - 分離されたViewModelを統合制御するMainViewModelを実装
  - ViewModel間の通信とデータ共有を実装
  - _要件: 3.2_

### 10. コマンドパターンの導入

- [ ] 10.1 IAsyncCommand インターフェースの作成
  - `Commands/IAsyncCommand.cs` を作成し、非同期コマンドインターフェースを定義
  - ICommand を継承し、非同期実行をサポート
  - _要件: 3.3_

- [ ] 10.2 具体的コマンドクラスの作成
  - ScanFolderCommand、GenerateThumbnailCommand等の具体的コマンドを作成
  - 各コマンドで適切な処理をカプセル化
  - _要件: 3.3_

- [ ] 10.3 ViewModelでのコマンド使用
  - 既存の処理をコマンドオブジェクトに置き換え
  - コマンドの再利用性と可読性を向上
  - _要件: 3.3_

### 11. ファクトリーパターンの導入

- [ ] 11.1 ViewModelFactory の作成
  - `Factories/ViewModelFactory.cs` を作成し、ViewModel生成を責任分離
  - 依存関係の注入とオブジェクト生成をカプセル化
  - _要件: 3.4_

- [ ] 11.2 ServiceFactory の作成
  - `Factories/ServiceFactory.cs` を作成し、Service生成を責任分離
  - 複雑なService初期化処理をカプセル化
  - _要件: 3.4_

- [ ] 11.3 既存オブジェクト生成の置き換え
  - 直接的なオブジェクト生成をファクトリー経由に置き換え
  - オブジェクト作成の責任を明確化
  - _要件: 3.4_

## Phase 4: パフォーマンス最適化（中リスク）

### 12. メモリ使用量の最適化

- [ ] 12.1 ページング処理の導入
  - `Services/IPagedMangaRepository.cs` インターフェースを作成
  - PagedResult<T> クラスを実装し、ページング機能を提供
  - _要件: 4.1_

- [ ] 12.2 ストリーミング処理の実装
  - IAsyncEnumerable を使用したストリーミング処理を実装
  - 大量データ処理時のメモリ使用量を削減
  - _要件: 4.1_

- [ ] 12.3 メモリプールの活用
  - ArrayPool<T> を使用したメモリプール実装
  - GC圧力を軽減し、パフォーマンスを向上
  - _要件: 4.1_

### 13. データベースクエリの最適化

- [ ] 13.1 N+1問題の解決
  - バッチクエリを実装し、関連データを単一クエリで取得
  - クエリ実行回数を削減し、パフォーマンスを向上
  - _要件: 4.2_

- [ ] 13.2 インデックス活用クエリの実装
  - FTSインデックスを活用した高速検索クエリを実装
  - 検索パフォーマンスを大幅に向上
  - _要件: 4.2_

- [ ] 13.3 クエリキャッシュの実装
  - 頻繁に実行されるクエリ結果をキャッシュ
  - データベースアクセスを削減
  - _要件: 4.2_

### 14. 並列処理の最適化

- [ ] 14.1 動的並列度制御の実装
  - CPU使用率に基づく動的な並列度制御を実装
  - システムリソースを効率的に活用
  - _要件: 4.3_

- [ ] 14.2 タスクスケジューリングの改善
  - カスタムTaskSchedulerを実装し、タスク実行を最適化
  - 処理優先度に基づくスケジューリングを実現
  - _要件: 4.3_

- [ ] 14.3 リソース管理の改善
  - SemaphoreSlim を使用したリソース制御を実装
  - 同時実行数を適切に制限
  - _要件: 4.3_

### 15. キャッシュ戦略の改善

- [ ] 15.1 多層キャッシュシステムの実装
  - メモリキャッシュとディスクキャッシュの多層構造を実装
  - キャッシュヒット率を向上
  - _要件: 4.4_

- [ ] 15.2 キャッシュ無効化戦略の実装
  - データ更新時の適切なキャッシュ無効化を実装
  - データ整合性を保ちながらキャッシュ効果を最大化
  - _要件: 4.4_

- [ ] 15.3 キャッシュメトリクスの実装
  - キャッシュヒット率、メモリ使用量等のメトリクスを実装
  - キャッシュ効果を可視化
  - _要件: 4.4_

## Phase 5: 拡張性向上（低リスク）

### 16. プラグインアーキテクチャの構築

- [ ] 16.1 プラグインインターフェースの定義
  - `Plugins/IMangaPlugin.cs` インターフェースを作成
  - プラグインの基本契約を定義
  - _要件: 5.1_

- [ ] 16.2 プラグインマネージャーの実装
  - `Plugins/PluginManager.cs` を作成し、プラグインの動的読み込みを実装
  - プラグインのライフサイクル管理を実装
  - _要件: 5.1_

- [ ] 16.3 プラグインホストの実装
  - プラグイン実行環境を提供するホストを実装
  - セキュリティとサンドボックス機能を実装
  - _要件: 5.1_

### 17. イベント駆動アーキテクチャの導入

- [ ] 17.1 イベントバスの実装
  - `Events/IEventBus.cs` インターフェースとEventBus実装を作成
  - 疎結合なコンポーネント間通信を実現
  - _要件: 5.2_

- [ ] 17.2 ドメインイベントの定義
  - FileScannedEvent、ThumbnailGeneratedEvent等のドメインイベントを定義
  - 適切なイベントペイロードを設計
  - _要件: 5.2_

- [ ] 17.3 イベントハンドラーの実装
  - 各ドメインイベントに対応するハンドラーを実装
  - イベント駆動による処理フローを構築
  - _要件: 5.2_

### 18. 設定システムの拡張性向上

- [ ] 18.1 複数設定プロバイダーの対応
  - JSON、XML、データベース等の複数設定ソースに対応
  - 設定プロバイダーの抽象化を実装
  - _要件: 5.3_

- [ ] 18.2 階層化設定の実装
  - 設定の階層構造をサポート
  - 設定の継承と上書き機能を実装
  - _要件: 5.3_

- [ ] 18.3 設定変更通知の実装
  - 設定変更時の自動通知機能を実装
  - リアルタイムな設定反映を実現
  - _要件: 5.3_

### 19. 国際化対応の準備

- [ ] 19.1 リソースファイルの準備
  - 多言語対応用のリソースファイル構造を構築
  - 文字列の外部化基盤を整備
  - _要件: 5.4_

- [ ] 19.2 ローカライゼーション基盤の実装
  - 動的言語切り替え機能を実装
  - 文化圏に応じた表示形式対応を実装
  - _要件: 5.4_

- [ ] 19.3 国際化テストの準備
  - 多言語環境でのテスト基盤を準備
  - 文字エンコーディング対応を確認
  - _要件: 5.4_

## 最終検証タスク

### 20. 全体統合テスト

- [ ] 20.1 機能回帰テストの実施
  - 全ての既存機能が正常に動作することを確認
  - パフォーマンスが劣化していないことを確認
  - _全要件_

- [ ] 20.2 アーキテクチャ検証
  - 新しいアーキテクチャが安定して動作することを確認
  - メモリ使用量とパフォーマンスの改善を確認
  - _全要件_

- [ ] 20.3 拡張性検証
  - プラグインシステムが正常に動作することを確認
  - イベント駆動システムが正常に動作することを確認
  - _要件: 5.1, 5.2_

## 実行ガイドライン

### 🚨 各タスク実行前の必須確認事項
**全てのタスク実行前に `Documents/SAFE_REFACTORING_PLAN.md` の以下ルールを必ず確認・理解すること：**

#### 絶対に守るべき禁止事項
1. **自動テスト・検証用ファイル生成の禁止**
   - テスト用プロジェクトの作成は行わない
   - 検証用ソースコードの生成は行わない
   - アプリケーションの動作検証は全てユーザーが手動で実施

2. **文字列置換による一括書き換えの禁止**
   - 一括置換機能は絶対に使用しない
   - コードの編集は1行ずつ慎重に行う
   - 変更箇所は必ず個別に確認してから実行

3. **短絡的な修正の禁止**
   - ビルドエラー発生時は思い付きで修正しない
   - 原因を慎重に分析してから修正案を提示
   - 修正前に必ずユーザーの承認を得る

#### 必須の確認事項
1. **各タスク完了後のビルド確認**
   - 必ずビルドエラーがないことを確認
   - エラーがある場合は即座に報告

2. **段階的な実行**
   - 1つのタスクが完了してから次に進む
   - 各段階でユーザーの確認を得る

3. **慎重な編集**
   - コードの編集は慎重に、安全に、丁寧に行う
   - 変更理由を明確にする

### 安全性確保
1. 各タスク実行前に現在のコードをバックアップ
2. 各タスク完了後に必ずビルドエラーがないことを確認
3. ビルドエラー発生時は原因分析後にユーザー承認を得てから修正
4. 各Phase完了後にユーザーによる動作確認を実施

### 品質保証
1. コードの編集は慎重かつ丁寧に実施
2. 文字列の一括置換は使用しない
3. 変更内容は明確に記録
4. 各変更の影響範囲を事前に特定

### 進捗管理
1. 各タスクの開始・完了を明確に記録
2. 問題発生時は即座に報告
3. Phase間の移行条件を厳密に確認
4. 最終的な成功基準を満たすことを確認

### エラー発生時の対応手順
1. **即座に作業停止**
2. **エラー内容の詳細分析**
3. **原因の特定**
4. **修正案の策定**
5. **ユーザーへの報告と承認依頼**
6. **承認後の慎重な修正**